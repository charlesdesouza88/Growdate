@page "/select-region"
@using GrowDate.Frontend.Services
@using GrowDate.Core.DTOs
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject RegionStateService RegionState
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Select Region</PageTitle>

<div class="region-selector">
    <h1>üåç Select Your Region</h1>
    <p>Choose your location on the interactive 3D globe or from the list below</p>

    @if (loading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading regions...</p>
        </div>
    }
    else if (!regions.Any())
    {
        <p>No regions available. Please check your connection to the API.</p>
    }
    else
    {
        <div class="globe-wrapper">
            <div id="globe-container" class="globe-container"></div>
            <div class="globe-info">
                <p>üñ±Ô∏è Click and drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Click markers to select</p>
            </div>
        </div>

        <div class="region-grid">
            @foreach (var region in regions)
            {
                <div class="region-card @(selectedRegion?.Id == region.Id ? "selected" : "")" 
                     @onclick="() => OnSelectRegion(region)">
                    <h3>üìç @region.Name</h3>
                    <p><strong>Country:</strong> @region.Country</p>
                    <p><strong>Climate Zone:</strong> @region.ClimateZone</p>
                    <p><strong>Coordinates:</strong> @region.Latitude.ToString("F2"), @region.Longitude.ToString("F2")</p>
                    @if (selectedRegion?.Id == region.Id)
                    {
                        <div class="selected-indicator">‚úì Selected</div>
                    }
                </div>
            }
        </div>

        @if (selectedRegion != null)
        {
            <div class="action-buttons">
                <button class="btn" @onclick="ViewCalendar">View Calendar ‚Üí</button>
                <button class="btn" @onclick="ViewRecommendations">View Recommendations ‚Üí</button>
            </div>
        }
    }
</div>

@code {
    private List<RegionDto> regions = new();
    private RegionDto? selectedRegion;
    private bool loading = true;
    private DotNetObjectReference<SelectRegion>? dotNetReference;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            regions = await ApiService.GetRegionsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading regions: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && regions.Any())
        {
            try
            {
                dotNetReference = DotNetObjectReference.Create(this);
                
                // Wait a bit for THREE.js to load from CDN
                await Task.Delay(500);
                
                await JS.InvokeVoidAsync("initGlobe", regions, dotNetReference);
                Console.WriteLine("Globe initialization called successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing 3D globe: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public void OnRegionSelected(int regionId)
    {
        var region = regions.FirstOrDefault(r => r.Id == regionId);
        if (region != null)
        {
            OnSelectRegion(region);
            StateHasChanged();
        }
    }

    private void OnSelectRegion(RegionDto region)
    {
        selectedRegion = region;
        RegionState.SetRegion(region);
    }

    private void ViewCalendar()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/calendar");
        }
    }

    private void ViewRecommendations()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/recommendations");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("disposeGlobe");
            dotNetReference?.Dispose();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing globe: {ex.Message}");
        }
    }
}
