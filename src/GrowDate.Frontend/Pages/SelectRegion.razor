@page "/select-region"
@using GrowDate.Frontend.Services
@using GrowDate.Core.Entities
@inject ApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Select Region</PageTitle>

<div class="region-selector">
    <h1>üó∫Ô∏è Select Your Region</h1>
    <p>Choose your location to get personalized planting recommendations</p>

    @if (loading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading regions...</p>
        </div>
    }
    else if (!regions.Any())
    {
        <p>No regions available. Please check your connection to the API.</p>
    }
    else
    {
        <div class="map-container">
            <canvas id="regionMap" class="map-canvas"></canvas>
        </div>

        <div class="region-grid">
            @foreach (var region in regions)
            {
                <div class="region-card @(selectedRegion?.Id == region.Id ? "selected" : "")" 
                     @onclick="() => OnSelectRegion(region)">
                    <h3>üìç @region.Name</h3>
                    <p><strong>Country:</strong> @region.Country</p>
                    <p><strong>Climate Zone:</strong> @region.ClimateZone</p>
                    <p><strong>Coordinates:</strong> @region.Latitude.ToString("F2"), @region.Longitude.ToString("F2")</p>
                    @if (selectedRegion?.Id == region.Id)
                    {
                        <div class="selected-indicator">‚úì Selected</div>
                    }
                </div>
            }
        </div>

        @if (selectedRegion != null)
        {
            <div class="action-buttons">
                <button class="btn" @onclick="ViewCalendar">View Calendar ‚Üí</button>
                <button class="btn" @onclick="ViewRecommendations">View Recommendations ‚Üí</button>
            </div>
        }
    }
</div>

@code {
    private List<Region> regions = new();
    private Region? selectedRegion;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            regions = await ApiService.GetRegionsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading regions: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && regions.Any())
        {
            // In a real implementation, initialize 3D map here using Three.js or similar
            // For this prototype, we're using a simple 2D grid selection
        }
    }

    private void OnSelectRegion(Region region)
    {
        selectedRegion = region;
        // In a real app, save to state management or local storage
    }

    private void ViewCalendar()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/calendar");
        }
    }

    private void ViewRecommendations()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/recommendations");
        }
    }
}
