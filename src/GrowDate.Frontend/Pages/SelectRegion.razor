@page "/select-region"
@using GrowDate.Frontend.Services
@using GrowDate.Core.DTOs
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject RegionStateService RegionState
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Select Region</PageTitle>

<div class="region-selector">
    <h1>üåç Select Your Region</h1>
    <p>Choose your location on the interactive 3D globe or from the list below</p>

    @if (loading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading regions...</p>
        </div>
    }

    <!-- Interactive 2D Map -->
    <div class="map-wrapper">
        <div id="map-container" class="map-container">
            <div style="color: white; text-align: center; padding: 20px;">
                <p>üó∫Ô∏è Interactive Region Map</p>
                @if (!regions.Any() && !loading)
                {
                    <p style="color: #ff6b6b;">‚ö†Ô∏è No regions loaded from API</p>
                    <p style="color: #ffd93d;">Using sample regions for demonstration</p>
                }
                else if (regions.Any())
                {
                    <p style="color: #4CAF50;">‚úÖ @regions.Count() regions loaded from API</p>
                }
            </div>
        </div>
        <div class="map-info">
            <p>üñ±Ô∏è Click regions to select ‚Ä¢ Hover for details</p>
        </div>
        <div style="margin: 10px 0;">
            <button class="btn" @onclick="LoadInteractiveMap" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px;">üó∫Ô∏è Load Interactive Map</button>
        </div>
    </div>

    @if (!regions.Any() && !loading)
    {
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
            <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è API Connection Issue</h4>
            <p style="color: #856404; margin: 0;">No regions available. Please check your connection to the API at <code>http://localhost:5100</code></p>
        </div>
    }
    else if (regions.Any())
    {

        <div class="region-grid">
            @foreach (var region in regions)
            {
                <div class="region-card @(selectedRegion?.Id == region.Id ? "selected" : "")" 
                     @onclick="() => OnSelectRegion(region)">
                    <h3>üìç @region.Name</h3>
                    <p><strong>Country:</strong> @region.Country</p>
                    <p><strong>Climate Zone:</strong> @region.ClimateZone</p>
                    <p><strong>Coordinates:</strong> @region.Latitude.ToString("F2"), @region.Longitude.ToString("F2")</p>
                    @if (selectedRegion?.Id == region.Id)
                    {
                        <div class="selected-indicator">‚úì Selected</div>
                    }
                </div>
            }
        </div>

        @if (selectedRegion != null)
        {
            <div class="action-buttons">
                <button class="btn" @onclick="ViewCalendar">View Calendar ‚Üí</button>
                <button class="btn" @onclick="ViewRecommendations">View Recommendations ‚Üí</button>
            </div>
        }
    }
</div>

@code {
    private List<RegionDto> regions = new();
    private RegionDto? selectedRegion;
    private bool loading = true;
    private DotNetObjectReference<SelectRegion>? dotNetReference;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("üöÄ Starting to load regions from API...");
            Console.WriteLine($"API Base URL from config: {ApiService}");
            
            regions = await ApiService.GetRegionsAsync();
            Console.WriteLine($"‚úÖ Successfully loaded {regions.Count} regions from API");
            
            if (regions.Any())
            {
                foreach (var region in regions)
                {
                    Console.WriteLine($"   - {region.Name} ({region.Country})");
                }
            }
            else
            {
                Console.WriteLine("‚ö†Ô∏è No regions returned from API call");
            }
        }
        catch (HttpRequestException httpEx)
        {
            Console.WriteLine($"‚ùå HTTP Error loading regions: {httpEx.Message}");
            Console.WriteLine($"   Status: {httpEx.Data}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå General error loading regions: {ex.Message}");
            Console.WriteLine($"   Type: {ex.GetType().Name}");
            Console.WriteLine($"   Stack: {ex.StackTrace}");
        }
        finally
        {
            loading = false;
            Console.WriteLine($"üèÅ Loading completed. Final state: {regions.Count} regions loaded");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetReference = DotNetObjectReference.Create(this);
                
                // Make the reference available globally for JavaScript
                await JS.InvokeVoidAsync("setBlazorReference", dotNetReference);
                
                // Wait a bit for the page to settle
                await Task.Delay(500);
                
                // Load the interactive 2D map
                await JS.InvokeVoidAsync("loadInteractiveMap");
                Console.WriteLine("Interactive 2D map initialized successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing interactive map: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public void OnRegionSelected(int regionId)
    {
        var region = regions.FirstOrDefault(r => r.Id == regionId);
        if (region != null)
        {
            OnSelectRegion(region);
            StateHasChanged();
        }
    }

    private void OnSelectRegion(RegionDto region)
    {
        selectedRegion = region;
        RegionState.SetRegion(region);
    }

    private void ViewCalendar()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/calendar");
        }
    }

    private void ViewRecommendations()
    {
        if (selectedRegion != null)
        {
            Navigation.NavigateTo("/recommendations");
        }
    }

    private async Task LoadInteractiveMap()
    {
        try
        {
            await JS.InvokeVoidAsync("loadInteractiveMap");
            Console.WriteLine("Interactive 2D map loaded");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"2D map loading failed: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMapRegionSelected(string regionName)
    {
        try
        {
            Console.WriteLine($"Region selected via JavaScript: {regionName}");
            
            // Find the region by name and select it
            var region = regions.FirstOrDefault(r => r.Name.Equals(regionName, StringComparison.OrdinalIgnoreCase));
            if (region != null)
            {
                OnSelectRegion(region);
                await Task.CompletedTask; // To satisfy async requirement
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Warning: Region '{regionName}' not found in loaded regions");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling region selection: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("disposeGlobe");
            dotNetReference?.Dispose();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing globe: {ex.Message}");
        }
    }
}
